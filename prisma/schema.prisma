// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STAF
}

enum EntityType {
  USER
  SURAT_KELUAR
}

enum Action {
  LOGIN
  CREATE
  READ
  UPDATE
  DELETE
  EXPORT
}

model User {
  id            String        @id @default(uuid())
  username      String        @unique
  namaLengkap   String
  role          Role          @default(STAF)
  tandaTangan   Bytes?
  createdAt     DateTime      @default(now())

  suratDibuat   SuratKeluar[] @relation("SuratDibuatOleh")
  suratDihapus  SuratKeluar[] @relation("SuratDihapusOleh")
  logs          ActivityLog[]

  @@index([role])
  @@index([username])
}

model SuratKeluar {
  id            String   @id @default(uuid())
  tanggalKirim  DateTime
  nomorSurat    String   @unique
  tanggalSurat  DateTime
  perihal       String
  tujuan        String
  keterangan    String?

  // Optional path for signature storage
  signDirectory String?  // <-- optional (nullable)

  userId        String
  createdBy     User     @relation("SuratDibuatOleh", fields: [userId], references: [id], onUpdate: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  deletedAt     DateTime?
  deletedById   String?
  deletedBy     User?    @relation("SuratDihapusOleh", fields: [deletedById], references: [id], onUpdate: Cascade)

  @@index([tanggalKirim])
  @@index([tanggalSurat])
  @@index([tujuan])
  @@index([perihal])
}


model ActivityLog {
  id         String     @id @default(uuid())
  occurredAt DateTime   @default(now())
  action     Action
  entityType EntityType
  entityId   String
  userId     String
  user       User       @relation(fields: [userId], references: [id], onUpdate: Cascade)
  metadata   Json?

  @@index([occurredAt])
  @@index([action])
  @@index([entityType, entityId])
  @@index([userId, occurredAt])
}
